name: Update Version Skew Documentation

on:
  schedule:
    # Run daily at 11am UTC (after the docs update workflows)
    - cron: '0 11 * * *'
  workflow_dispatch: # Allow manual trigger
    inputs:
      version:
        description: 'Helm major version to update (v2 or v3)'
        required: true
        default: 'v3'
        type: choice
        options:
          - v2
          - v3

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version-skew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # pin@v5.1.0
        with:
          go-version-file: 'sdkexamples/go.mod'
          check-latest: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run version skew update
        run: make update-version-skew VERSION=${{ inputs.version || 'v3' }}

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for existing PRs
        id: existing-pr
        run: |
          existing_pr=$(gh pr list --state open --author "github-actions[bot]" --head-match "update-version-skew-*" --json number --jq '.[0].number // empty')
          if [ -n "$existing_pr" ]; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "Existing PR #$existing_pr found, skipping creation"
          else
            echo "existing_pr=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && steps.existing-pr.outputs.existing_pr == 'false'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # pin@v7.0.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update Kubernetes version skew table"
          title: "docs: update Kubernetes version skew table"
          body: |
            This is an automated pull request to update the Kubernetes version skew documentation.
            
            ## Changes
            This PR includes automatic updates for:
            - ✅ Updated Helm/Kubernetes compatibility table based on latest Helm release
            - ✅ Added or updated supported Kubernetes versions for the latest Helm version
            
            ## Details
            The update process:
            1. Fetched the latest stable Helm v3 release from GitHub
            2. Extracted the `k8s.io/client-go` version from the release's `go.mod`
            3. Calculated the supported Kubernetes versions (current and 3 prior minor versions)
            4. Updated the version skew table in `content/en/docs/topics/version_skew.md`
            
            Generated by the version skew update workflow at $(date).
            
            ## Review Notes
            Please verify that:
            - [ ] The Helm version is correct
            - [ ] The Kubernetes version range follows the n-3 support policy
            - [ ] The table formatting is preserved
          branch: "update-version-skew-$(date +%Y%m%d-%H%M%S)"
          delete-branch: true